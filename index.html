<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>راهنمای حرفه‌ای حرم امام رضا — مسیر‌یاب داخلی</title>
  <meta name="description" content="مسیر‌یابی حرفه‌ای داخل حرم امام رضا، جستجو، فیلتر، عکس و مسیر داخلی بر پایهٔ گراف صحن‌ها و رواق‌ها." />

  <!-- Leaflet + MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

  <style>
    /* ---------- Theme & Layout ---------- */
    :root{
      --accent: #0b6;
      --accent-dark: #0a6b5b;
      --muted: #6b7280;
      --bg: #f6f8fb;
      --card: #fff;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(2,6,23,0.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Vazirmatn",Tanha, Tahoma, sans-serif;background:var(--bg);color:#0f172a; -webkit-font-smoothing:antialiased}
    header{background:linear-gradient(90deg,var(--accent-dark),var(--accent));color:#fff;padding:14px 18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .brand{font-weight:800;font-size:18px}
    .subtitle{font-size:13px;opacity:0.92}
    .controls{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"], select{padding:9px 12px;border-radius:10px;border:1px solid rgba(2,6,23,0.06);min-width:160px}
    button{padding:9px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;box-shadow:var(--shadow)}
    button.ghost{background:transparent;color:#fff;border:1px solid rgba(255,255,255,0.14)}
    button.small{padding:6px 8px;font-size:13px}
    main.container{max-width:1200px;margin:16px auto;padding:0 12px;display:grid;grid-template-columns:1fr 360px;gap:12px}
    #map{height:72vh;border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .panel{background:var(--card);border-radius:12px;padding:12px;box-shadow:var(--shadow);}

    /* places list */
    .places{height:72vh;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:6px}
    .place-card{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;border:1px solid #f0f3f7;background:#fff}
    .place-card img{width:78px;height:64px;border-radius:8px;object-fit:cover;background:#f3f4f6}
    .place-info h4{margin:0;font-size:15px}
    .place-info p{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .place-actions{margin-top:8px;display:flex;gap:8px}

    /* route summary and steps */
    .route-summary{margin-top:10px;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(11,102,95,0.04), rgba(11,102,95,0.02));border:1px solid #eef9f6}
    .meta{font-size:13px;color:var(--muted)}

    /* modal & gallery */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,0.45);z-index:4000;padding:12px}
    .modal.open{display:flex}
    .modal .card{background:#fff;border-radius:12px;padding:14px;max-width:480px;width:100%}
    .gallery{max-width:900px}
    .gallery img{width:100%;height:480px;object-fit:cover;border-radius:8px}

    /* responsive */
    @media (max-width:1000px){
      main.container{grid-template-columns:1fr;gap:10px}
      .places{height:36vh}
      #map{height:54vh}
    }

    /* small helpers */
    .filters{display:flex;flex-direction:column;gap:6px}
    select:focus,input:focus,button:focus{outline:3px solid rgba(11,102,95,0.12)}
  </style>
</head>
<body>
  <header>
    <div>
      <div class="brand">راهنمای کامل حرم امام رضا</div>
      <div class="subtitle">پیدا کن • نگاه کن • برو — مسیر‌یابی داخلی با گراف صحن‌ها</div>
    </div>

    <div class="controls" role="region" aria-label="کنترل‌های نقشه">
      <input id="search" type="text" placeholder="جستجو: صحن، رواق، باب..." aria-label="جستجو">
      <select id="start" aria-label="مبدا"></select>
      <select id="end" aria-label="مقصد"></select>
      <button id="routeBtn" title="مسیریابی">مسیریابی</button>
      <button id="locateBtn" class="ghost small" title="موقعیت من">موقعیت من</button>
    </div>
  </header>

  <main class="container" role="main">
    <div>
      <div id="map" class="panel"></div>

      <div style="display:flex;gap:12px;margin-top:12px">
        <div class="panel" style="flex:1">
          <strong>خلاصهٔ مسیر</strong>
          <div id="routeSummary" class="route-summary meta">هیچ مسیری محاسبه نشده است.</div>
          <div id="routeSteps" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
        </div>

        <div class="panel" style="width:260px">
          <strong>فیلترها</strong>
          <div class="filters" style="margin-top:8px">
            <label><input type="checkbox" class="filter" data-type="صحن" checked> صحن‌ها</label>
            <label><input type="checkbox" class="filter" data-type="رواق" checked> رواق‌ها</label>
            <label><input type="checkbox" class="filter" data-type="باب" checked> باب‌ها</label>
            <label><input type="checkbox" class="filter" data-type="مکان" checked> موزه و خدمات</label>
          </div>
        </div>
      </div>
    </div>

    <aside class="panel places" id="placesPanel" aria-live="polite"></aside>
  </main>

  <!-- modal for help -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="card">
      <h3>فعال‌سازی دسترسی به مکان</h3>
      <p class="meta">برای استفاده از «موقعیت من» مرورگر باید اجازهٔ دسترسی به مکان را بدهد. اگر قبلاً رد کرده‌اید، تنظیمات سایت را باز کرده و Location را Allow کنید. همچنین صفحه باید روی HTTPS یا localhost اجرا شود.</p>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button id="modalClose">متوجه شدم</button>
      </div>
    </div>
  </div>

  <!-- gallery modal -->
  <div id="gallery" class="modal" aria-hidden="true">
    <div class="card gallery">
      <img id="galleryImg" src="" alt="تصویر مکان">
      <div style="display:flex;justify-content:flex-end;margin-top:8px">
        <button id="galleryClose">بستن</button>
      </div>
    </div>
  </div>

  <!-- Leaflet scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
  /*************************************************************************
   * Index (single-file) — Professional internal routing for Haram guide
   * - Dijkstra on internal graph for accurate in-courtyard routing
   * - Geolocation request with helpful modal on deny
   * - Marker clustering, search, filters, gallery
   * - Put this file as index.html on GitHub Pages (HTTPS recommended)
   *************************************************************************/

  /* ---------------------- Data (places + graph) ----------------------- */
  // Approximate coordinates for main points — replace with exact coords if available
  const places = [
    {id:'golden_dome', name:'ضریح / گنبد طلا', type:'صحن', lat:36.28805, lon:59.61570, img:'https://picsum.photos/id/1011/800/500', desc:'مرکز زیارتی ضریح امام رضا (ع)'},
    {id:'goharshad', name:'مسجد گوهرشاد', type:'رواق', lat:36.28790, lon:59.61510, img:'https://picsum.photos/id/1012/800/500', desc:'مسجد تاریخی گوهرشاد'},
    {id:'sahn_enqelab', name:'صحن انقلاب (عتیق)', type:'صحن', lat:36.28800, lon:59.61540, img:'https://picsum.photos/id/1013/800/500', desc:'صحن قدیمی نزدیک ضریح'},
    {id:'sahn_azadi', name:'صحن آزادی', type:'صحن', lat:36.28860, lon:59.61620, img:'https://picsum.photos/id/1014/800/500', desc:'صحن بزرگ شرقی'},
    {id:'sahn_jamee', name:'صحن جامع رضوی', type:'صحن', lat:36.28910, lon:59.61500, img:'https://picsum.photos/id/1015/800/500', desc:'صحن جدید و بزرگ'},
    {id:'ravaq_sheikh', name:'رواق شیخ بهایی', type:'رواق', lat:36.28820, lon:59.61600, img:'https://picsum.photos/id/1020/800/500', desc:'رواق مشهور شیخ بهایی'},
    {id:'ivaan_abasi', name:'ایوان عباسی', type:'ایوان', lat:36.28815, lon:59.61595, img:'https://picsum.photos/id/1022/800/500', desc:'ایوان تاریخی عباسی'},
    {id:'bab_reza', name:'باب‌الرضا (ورودی)', type:'باب', lat:36.28905, lon:59.61560, img:'https://picsum.photos/id/1023/800/500', desc:'ورودی اصلی حرم'},
    {id:'museum', name:'موزه آستان قدس', type:'مکان', lat:36.28790, lon:59.61700, img:'https://picsum.photos/id/1024/800/500', desc:'موزهٔ مجموعه'},
    {id:'dokhtaran', name:'دروازهٔ شرقی (دختران)', type:'باب', lat:36.28880, lon:59.61720, img:'https://picsum.photos/id/1025/800/500', desc:'ورودی شرقی و بازار'},
    {id:'ravaq_tawhid', name:'رواق توحید', type:'رواق', lat:36.28870, lon:59.61595, img:'https://picsum.photos/id/1026/800/500', desc:'رواق توحیدی'},
    {id:'sabt_anam', name:'بازارها', type:'مکان', lat:36.28950, lon:59.61650, img:'https://picsum.photos/id/1028/800/500', desc:'بازارها و مسیرهای تجاری'},
    {id:'north_gate', name:'دروازهٔ شمالی', type:'باب', lat:36.28930, lon:59.61540, img:'https://picsum.photos/id/1034/800/500', desc:'ورودی شمالی'},
    {id:'library', name:'کتابخانهٔ آستان', type:'مکان', lat:36.28885, lon:59.61610, img:'https://picsum.photos/id/1037/800/500', desc:'کتابخانه و منابع'},
    {id:'restroom', name:'سرویس‌های بهداشتی', type:'مکان', lat:36.28810, lon:59.61650, img:'https://picsum.photos/id/1038/800/500', desc:'خدمات بهداشتی'},
    {id:'info_center', name:'مرکز راهنما', type:'مکان', lat:36.28890, lon:59.61580, img:'https://picsum.photos/id/1039/800/500', desc:'مرکز اطلاع‌رسانی و نقشه'}
  ];

  // internal graph: list of bidirectional edges (ids). Improve by adding more nodes/edges for accuracy.
  const edges = [
    ['golden_dome','ravaq_tawhid'],
    ['golden_dome','ravaq_sheikh'],
    ['ravaq_sheikh','ivaan_abasi'],
    ['ivaan_abasi','sahn_enqelab'],
    ['sahn_enqelab','sahn_azadi'],
    ['sahn_azadi','dokhtaran'],
    ['sahn_azadi','sabt_anam'],
    ['sabt_anam','dokhtaran'],
    ['sahn_jamee','north_gate'],
    ['sahn_jamee','sabt_anam'],
    ['ravaq_tawhid','ravaq_sheikh'],
    ['ravaq_sheikh','bab_reza'],
    ['bab_reza','ivaan_abasi'],
    ['ravaq_tawhid','golden_dome'],
    ['museum','dokhtaran'],
    ['library','info_center'],
    ['restroom','info_center'],
    ['info_center','golden_dome']
  ];

  /* ---------------------- Utility functions ----------------------- */
  // simple haversine (meters)
  function toRad(v){return v*Math.PI/180;}
  function haversine(a,b){
    const R=6371e3;
    const dLat=toRad(b[0]-a[0]), dLon=toRad(b[1]-a[1]);
    const lat1=toRad(a[0]), lat2=toRad(b[0]);
    const sin1=Math.sin(dLat/2), sin2=Math.sin(dLon/2);
    const c=2*Math.atan2(Math.sqrt(sin1*sin1 + Math.cos(lat1)*Math.cos(lat2)*sin2*sin2), Math.sqrt(1-(sin1*sin1 + Math.cos(lat1)*Math.cos(lat2)*sin2*sin2)));
    return R*c;
  }

  // find place by id
  const placeById = {};
  places.forEach(p => placeById[p.id] = p);

  /* ---------------------- Map init ----------------------- */
  const map = L.map('map', {zoomControl:true}).setView([36.28805,59.6157], 18);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20, attribution:'© OpenStreetMap'}).addTo(map);

  // marker cluster group
  const cluster = L.markerClusterGroup();

  // svg icon factory
  function svgIconHex(color){
    const svg = encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="40" height="52" viewBox="0 0 40 52"><path d="M20 0C12 0 5.5 6.2 5.5 13.8c0 10.7 14 28.7 13.9 28.8-.2.3-.4.6-.6.9.5.2 1.1.3 1.7.3.6 0 1.2-.1 1.7-.3-.2-.3-.4-.6-.6-.9C20.5 42.5 34.5 24.5 34.5 13.8 34.5 6.2 28 0 20 0z" fill="${color}"/><circle cx="20" cy="13.8" r="5" fill="white"/></svg>`);
    return L.icon({iconUrl: 'data:image/svg+xml;utf8,'+svg, iconSize:[28,36], iconAnchor:[14,36], popupAnchor:[0,-30]});
  }

  const icons = {
    'صحن': svgIconHex('#0b6'),
    'رواق': svgIconHex('#0a84a6'),
    'باب': svgIconHex('#d97706'),
    'مکان': svgIconHex('#6b21a8'),
    'ایوان': svgIconHex('#b91c1c')
  };

  // add markers
  const markers = {};
  places.forEach(p=>{
    const ic = icons[p.type] || icons['مکان'];
    const popup = `<div style="max-width:260px">
      <img src="${p.img}" alt="${p.name}" style="width:100%;height:140px;object-fit:cover;border-radius:8px;margin-bottom:6px" />
      <strong>${p.name}</strong><br/><small class="meta">${p.type}</small>
      <p style="margin-top:6px">${p.desc}</p>
      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="navBtn" data-id="${p.id}" style="padding:6px 8px;border-radius:8px;border:0;background:var(--accent);color:#fff;">مسیریابی</button>
        <button class="viewBtn" data-id="${p.id}" style="padding:6px 8px;border-radius:8px;border:1px solid #eee;background:#fff;">نمایش</button>
        <button class="imgBtn" data-img="${p.img}" style="padding:6px 8px;border-radius:8px;border:1px solid #eee;background:#fff;">عکس</button>
      </div></div>`;
    const m = L.marker([p.lat,p.lon], {icon: ic}).bindPopup(popup);
    m.on('popupopen', ()=>{ /* handlers delegated globally below */ });
    cluster.addLayer(m);
    markers[p.id] = m;
  });
  map.addLayer(cluster);

  /* ---------------------- UI population ----------------------- */
  const startEl = document.getElementById('start');
  const endEl = document.getElementById('end');
  const placesPanel = document.getElementById('placesPanel');
  const searchEl = document.getElementById('search');

  function populateSelectsAndList(){
    // start select: include "__me"
    startEl.innerHTML = '';
    const optMe = document.createElement('option'); optMe.value='__me'; optMe.textContent='موقعیت من'; startEl.appendChild(optMe);

    // group by type
    const groups = {};
    places.forEach(p => (groups[p.type] = groups[p.type] || []).push(p));
    Object.keys(groups).forEach(type=>{
      const og = document.createElement('optgroup'); og.label = type;
      groups[type].forEach(p=>{
        const o = document.createElement('option'); o.value = p.id; o.textContent = p.name; og.appendChild(o);
      });
      startEl.appendChild(og);
    });

    // end select: flat list
    endEl.innerHTML = '';
    places.forEach(p=>{ const o = document.createElement('option'); o.value = p.id; o.textContent = `${p.name} — ${p.type}`; endEl.appendChild(o); });

    renderPlaces(new Set(['صحن','رواق','باب','مکان']), '');
  }

  function renderPlaces(filterTypes, q){
    placesPanel.innerHTML = '';
    const query = (q||'').trim().toLowerCase();
    places.filter(p => filterTypes.has(p.type) && (query === '' || (p.name + ' ' + p.type + ' ' + p.desc).toLowerCase().includes(query)))
      .forEach(p=>{
        const card = document.createElement('div'); card.className='place-card';
        const img = document.createElement('img'); img.src = p.img;
        const info = document.createElement('div'); info.className='place-info';
        const h = document.createElement('h4'); h.textContent = p.name;
        const desc = document.createElement('p'); desc.textContent = p.type + ' · ' + p.desc;
        const actions = document.createElement('div'); actions.className='place-actions';
        const navBtn = document.createElement('button'); navBtn.textContent='مسیریابی'; navBtn.addEventListener('click', ()=>{ endEl.value = p.id; showRouteFromSelected(); });
        const viewBtn = document.createElement('button'); viewBtn.textContent='نمایش'; viewBtn.style.marginLeft='8px'; viewBtn.addEventListener('click', ()=>{ map.setView([p.lat,p.lon],19); markers[p.id].openPopup(); });
        const imgBtn = document.createElement('button'); imgBtn.textContent='عکس'; imgBtn.style.marginLeft='8px'; imgBtn.addEventListener('click', ()=> openGallery(p.img));
        actions.appendChild(navBtn); actions.appendChild(viewBtn); actions.appendChild(imgBtn);
        info.appendChild(h); info.appendChild(desc); info.appendChild(actions);
        card.appendChild(img); card.appendChild(info);
        placesPanel.appendChild(card);
      });
  }

  populateSelectsAndList();

  // filters UI
  const activeFilters = new Set(['صحن','رواق','باب','مکان']);
  document.querySelectorAll('.filter').forEach(ch=>{
    ch.addEventListener('change', e=>{
      const t = e.target.dataset.type;
      if(e.target.checked) activeFilters.add(t); else activeFilters.delete(t);
      renderPlaces(activeFilters, searchEl.value);
      toggleMarkersByFilter();
    });
  });

  searchEl.addEventListener('input', e=>{ renderPlaces(activeFilters, e.target.value); });

  function toggleMarkersByFilter(){
    cluster.clearLayers();
    places.forEach(p=>{ if(activeFilters.has(p.type)) cluster.addLayer(markers[p.id]); });
  }

  /* ---------------------- Geolocation helpers ----------------------- */
  let userMarker = null;
  let lastKnown = null;
  const modal = document.getElementById('modal');
  const routeSummaryEl = document.getElementById('routeSummary');
  const routeStepsEl = document.getElementById('routeSteps');

  function showModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
  function hideModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }
  document.getElementById('modalClose').addEventListener('click', hideModal);

  function locateUser({showHelpOnDenied=true} = {}){
    return new Promise((resolve,reject)=>{
      if(!navigator.geolocation){ alert('مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند.'); return reject('NO_GEO'); }
      navigator.geolocation.getCurrentPosition(pos=>{
        lastKnown = {lat: pos.coords.latitude, lon: pos.coords.longitude};
        if(userMarker) map.removeLayer(userMarker);
        userMarker = L.marker([lastKnown.lat,lastKnown.lon], {icon: svgIcon('#0a84a6')}).addTo(map).bindPopup('موقعیت شما').openPopup();
        map.setView([lastKnown.lat,lastKnown.lon], 18);
        resolve(lastKnown);
      }, err=>{
        if(err.code === err.PERMISSION_DENIED){
          if(showHelpOnDenied) showModal();
          reject({code:'PERMISSION_DENIED'});
        } else if(err.code === err.POSITION_UNAVAILABLE) {
          alert('موقعیت در دسترس نیست — مطمئن شوید GPS روشن است.');
          reject({code:'POSITION_UNAVAILABLE'});
        } else if(err.code === err.TIMEOUT) {
          alert('درخواست موقعیت زمان‌بر بود؛ دوباره تلاش کنید.');
          reject({code:'TIMEOUT'});
        } else reject({code:'UNKNOWN'});
      }, {enableHighAccuracy:true, timeout:15000, maximumAge:0});
    });
  }

  document.getElementById('locateBtn').addEventListener('click', ()=>{ locateUser().catch(()=>{}); });
  // keyboard L to locate
  document.addEventListener('keydown', e=>{ if(e.key.toLowerCase()==='l') locateUser().catch(()=>{}); });

  /* ---------------------- Icons & helpers ----------------------- */
  function svgIcon(color){
    const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='40' height='52' viewBox='0 0 40 52'><path d='M20 0C12 0 5.5 6.2 5.5 13.8c0 10.7 14 28.7 13.9 28.8-.2.3-.4.6-.6.9.5.2 1.1.3 1.7.3.6 0 1.2-.1 1.7-.3-.2-.3-.4-.6-.6-.9C20.5 42.5 34.5 24.5 34.5 13.8 34.5 6.2 28 0 20 0z' fill='${color}'/><circle cx='20' cy='13.8' r='5' fill='white'/></svg>`);
    return L.icon({iconUrl:'data:image/svg+xml;utf8,'+svg, iconSize:[28,36], iconAnchor:[14,36], popupAnchor:[0,-30]});
  }

  /* ---------------------- Routing (Dijkstra on internal graph) ----------------------- */
  // Build adjacency with weights (meters)
  function buildAdj(){
    const adj = {};
    places.forEach(p=> adj[p.id] = []);
    edges.forEach(e=>{
      const a = e[0], b = e[1];
      if(placeById[a] && placeById[b]){
        const w = haversine([placeById[a].lat, placeById[a].lon], [placeById[b].lat, placeById[b].lon]);
        adj[a].push({to:b, w}); adj[b].push({to:a, w});
      }
    });
    return adj;
  }

  function dijkstra(startId, endId){
    const adj = buildAdj();
    const dist = {}, prev = {}, visited = {};
    Object.keys(adj).forEach(k => { dist[k] = Infinity; prev[k] = null; visited[k] = false; });
    dist[startId] = 0;
    while(true){
      let u = null, ud = Infinity;
      for(const k in dist) if(!visited[k] && dist[k] < ud){ ud = dist[k]; u = k; }
      if(u === null) break;
      if(u === endId) break;
      visited[u] = true;
      adj[u].forEach(edge => {
        const alt = dist[u] + edge.w;
        if(alt < dist[edge.to]){ dist[edge.to] = alt; prev[edge.to] = u; }
      });
    }
    if(prev[endId] === null && startId !== endId) return null;
    const path = []; let cur = endId;
    while(cur){ path.unshift(cur); cur = prev[cur]; }
    return {path, distance: dist[endId]};
  }

  // nearest node to a coordinate
  function nearestNode(lat, lon){
    let best = null, bd = Infinity;
    places.forEach(p=>{
      const d = haversine([lat, lon], [p.lat, p.lon]);
      if(d < bd){ bd = d; best = p.id; }
    });
    return {id: best, dist: bd};
  }

  // drawing management
  let internalPolyline = null;
  function clearInternalRoute(){ if(internalPolyline) { map.removeLayer(internalPolyline); internalPolyline = null; } }

  // threshold to say "this point is inside/close to the internal network" (meters)
  const INSIDE_THRESHOLD_METERS = 90;

  async function showRoute(startIdOrMe, endId){
    clearInternalRoute();
    if(window.routingControl){ try{ map.removeControl(window.routingControl); } catch(e){} window.routingControl = null; }
    routeSummaryEl.textContent = 'در حال محاسبهٔ مسیر…'; routeStepsEl.innerHTML = '';
    try{
      // resolve start coordinates
      let startCoords;
      if(startIdOrMe === '__me'){
        const got = await locateUser(); startCoords = [got.lat, got.lon];
      } else {
        const s = placeById[startIdOrMe]; startCoords = [s.lat, s.lon];
      }
      const e = placeById[endId]; const endCoords = [e.lat, e.lon];

      // check proximity to internal network
      const startNearest = nearestNode(startCoords[0], startCoords[1]);
      const endNearest   = nearestNode(endCoords[0], endCoords[1]);

      // if both close enough, use internal graph Dijkstra
      if(startNearest.dist <= INSIDE_THRESHOLD_METERS && endNearest.dist <= INSIDE_THRESHOLD_METERS){
        const res = dijkstra(startNearest.id, endNearest.id);
        if(res && res.path && res.path.length){
          const latlngs = [];
          if(startIdOrMe === '__me') latlngs.push(startCoords);
          res.path.forEach(id => latlngs.push([placeById[id].lat, placeById[id].lon]));
          if(latlngs[latlngs.length-1][0] !== endCoords[0] || latlngs[latlngs.length-1][1] !== endCoords[1]){
            latlngs.push(endCoords);
          }
          internalPolyline = L.polyline(latlngs, {color:varOr('#0b6','#0b6'), weight:5, opacity:0.95}).addTo(map);
          map.fitBounds(internalPolyline.getBounds(), {padding:[40,40]});
          const total = latlngs.reduce((acc, cur, i, arr)=> i===0?0:acc + haversine(arr[i-1], cur), 0);
          const mins = Math.round((total / 1.4) / 60);
          routeSummaryEl.innerHTML = `<strong>مسیر داخلی:</strong> ${Math.round(total)} متر — زمان تقریبی: ${mins} دقیقه`;
          routeStepsEl.innerHTML = `<div class="meta">مسیر بر اساس شبکهٔ داخلی صحن‌ها و رواق‌ها محاسبه شد. گره‌ها: ${res.path.length}</div>`;
          return;
        }
      }

      // fallback: direct polyline (we prefer internal graph; external OSRM not used here to avoid routing out-of-courtyard)
      const line = L.polyline([startCoords, endCoords], {color:'#0b6', weight:4, dashArray:'8 6'}).addTo(map);
      map.fitBounds(line.getBounds(), {padding:[40,40]});
      const d = Math.round(haversine(startCoords, endCoords));
      const mins = Math.round((d/1.4)/60);
      routeSummaryEl.innerHTML = `<strong>مسیر مستقیم (پیشنهاد):</strong> ${d} متر — ${mins} دقیقه`;
      routeStepsEl.innerHTML = `<div class="meta">مسیر مستقیم بین مبدا و مقصد (اگر شبکهٔ داخلی کامل‌تر شود، مسیر طبیعی‌تر خواهد بود).</div>`;

    }catch(err){
      if(err && err.code === 'PERMISSION_DENIED') routeSummaryEl.textContent = 'دسترسی به مکان رد شد — مبدا را دستی انتخاب کنید.';
      else routeSummaryEl.textContent = 'خطا در محاسبهٔ مسیر.';
    }
  }

  // convenience wrapper
  function showRouteFromSelected(){
    const s = startEl.value, e = endEl.value;
    if(!e){ alert('لطفاً مقصد را انتخاب کنید'); return; }
    showRoute(s, e);
  }

  // helper for color variable (older browsers)
  function varOr(a,b){ return a || b; }

  /* ---------------------- Button hooks & delegation ----------------------- */
  document.getElementById('routeBtn').addEventListener('click', showRouteFromSelected);

  // delegate popup buttons (navBtn, viewBtn, imgBtn)
  document.addEventListener('click', e=>{
    if(e.target.matches('.navBtn')){ const id = e.target.dataset.id; endEl.value = id; showRouteFromSelected(); }
    if(e.target.matches('.viewBtn')){ const id = e.target.dataset.id; const p = placeById[id]; if(p) { map.setView([p.lat,p.lon],19); markers[id].openPopup(); } }
    if(e.target.matches('.imgBtn')){ const url = e.target.dataset.img; openGallery(url); }
  });

  /* ---------------------- Gallery modal ----------------------- */
  function openGallery(url){ if(!url) return; document.getElementById('galleryImg').src = url; document.getElementById('gallery').classList.add('open'); }
  document.getElementById('galleryClose').addEventListener('click', ()=> document.getElementById('gallery').classList.remove('open'));

  /* ---------------------- Initial state & helpers ----------------------- */
  // set initial selects, restore from localStorage if present
  function init(){
    populateSelectsAndList();
    try{
      const last = JSON.parse(localStorage.getItem('haram.last') || '{}');
      if(last.start) startEl.value = last.start;
      if(last.end) endEl.value = last.end;
    }catch(e){}
    // a warm try to get permission quietly (no modal on deny)
    locateUser({showHelpOnDenied:false}).catch(()=>{});
  }
  init();

  // persist last choices when route computed
  const origShowRoute = showRoute;
  // wrap to persist
  async function showRoutePersist(startIdOrMe, endId){
    await origShowRoute(startIdOrMe, endId);
    localStorage.setItem('haram.last', JSON.stringify({start:startIdOrMe, end:endId}));
  }
  // overwrite with persistent wrapper
  showRoute = showRoutePersist;

  </script>
</body>
</html>
